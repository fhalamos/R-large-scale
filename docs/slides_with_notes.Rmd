---
title: "Large-scale data analysis in R"
author: Peter Carbonetto
output:
  beamer_presentation:
    template: docs/beamer.tex
    keep_tex: false
    fig_caption: false
    pandoc_args: "--highlight-style=pygments"
---

```{r knitr-options, echo=FALSE}
knitr::opts_chunk$set(results = "hide",fig.show = "hide",
                      message = FALSE,warning = FALSE)
```

Workshop aims
=============

1. Develop skills for large-scale data analyis in R, and apply these
skills to a large-ish data set.

2. Learn how to use R **non-interactively** within a high-performance
computing (HPC) environment.

3. Assess memory needs, and make good use of it.

4. Speeding up your R analyses by...

    + Using simple parallelization techniques.

    + Interfacing to C code.

5. Learn through **live coding**---this includes learning from our
mistakes!

It's your choice
================

You may choose to...

+ Use R on the RCC cluster.

+ Use R on your laptop.

+ Pair up with your neighbour.

+ Follow what I do on the projector.

Please note:

+ You should use R, not RStudio.
 
+ Some of the examples will not work on your laptop.

Software we will use today
==========================

1. R

2. Python 3.x (used to measure memory usage).

3. Slurm (job scheduler on RCC cluster).

4. R packages **readr**, ...

*These programs and R packages are already installed on the cluster.*

The large data set
==================

+ **RegMap data:** genetic and ecological data on *Arabidopsis thaliana*
in a range of climates.

+ From Joy Bergelson's lab at the University of Chicago.

+ See [Hancock et al (2011) *Science* 334, 83--86][hancock-2011].

Outline of workshop
===================

1. Initial setup.

2. Vignettes:

    + *Add vignettes here.*

Initial setup
=============

+ WiFi.

+ Power outlets.

+ Workshop packet.

+ Reading what I type.

+ Pace & questions (e.g., keyboard shortcuts).

+ Help.

Download workshop packet
========================

Once you have connected to a midway2 login node, download the workshop
packet to your home directory on the cluster (**note:** no spaces in URL):

```bash
cd $HOME
git clone https://github.com/rcc-uchicago/
  R-large-scale.git
```

*Optionally,* you may also download the repository to your laptop.

What's included in the workshop packet
======================================

+ **slides.pdf:** These slides.

+ *Describe more of the files here.*

Copy the data
=============

Copy and uncompress the data in the same location as the other
workshop files:

```bash
cd R-large-scale
cp ~pcarbo/share/regmap.tar.gz .
tar zxvf regmap.tar.gz
```

Connect to a midway2 compute node
=================================

Request access to a midway2 ("Broadwell") compute node with 8 CPUs and
18 GB of memory:

```bash
screen -S workshop
sinteractive --partition=broadwl \
  --reservation=workshop --cpus-per-task=8 \
  --mem=18G --time=3:00:00 
echo $HOSTNAME
```

Set up your shell environment
=============================

*Add instructions here.*

Launch R
========

Start up an R interactive environment:

```bash
module load R/3.5.1
R
```

Check your R environment
========================

Check that your R environment is set up correctly:

```{r check-environment}
sessionInfo()
ls()
getwd()
```

> Instructor notes: If `ls()` does not return `character(0)`, clear
> your environment by running `rm(list = ls())`.

Launch a second console to monitor computations
===============================================

*Add instructions here.*

Vignette #1: Importing a large data set
=======================================

*Add text here.*

```{r import-data-readcsv}
geno <- read.csv("geno.csv")
```

> Instructor notes: Before importing the data into R, inspect the CSV
> file.

Import data using `readr`
=========================

*Add text here.*

```{r import-data-readr}
geno <- read_csv("geno.csv")
class(geno) <- "data.frame"
```

Timing the data import step
===========================

*Add text here.*

```{r time-import-data-readr}
timing <- system.time(geno <- read_csv("geno.csv"))
```

[hancock-2011]: http://dx.doi.org/10.1126/science.1209244 
